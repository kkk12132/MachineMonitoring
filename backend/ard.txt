#include <WiFiS3.h>
#include <Arduino.h>

// ======================
// üîß WiFi Configuration
// ======================
const char* ssid = "JIO Office";
const char* password = "12345678@";

// ======================
// üåê Server Configuration
// ======================
const char* server = "192.168.31.142";
const int port = 3000;
const char* deviceName = "arduino-1";

IPAddress localIP(192, 168, 31, 50);
IPAddress gateway(192, 168, 31, 1);
IPAddress subnet(255, 255, 255, 0);

WiFiClient client;

// ======================
// ‚öôÔ∏è Pins
// ======================
const int pin2 = 2;
const int pin3 = 3;
const int pin4 = 4;

// ======================
// ‚öôÔ∏è ENHANCED Noise Filtering
// ======================
const unsigned long DEBOUNCE_DELAY = 250; // Increased from 100ms to 250ms
const int CONSECUTIVE_READS = 5;          // Must read same value 5 times
const int READ_INTERVAL = 10;             // 10ms between reads

struct PinFilter {
  int lastStableState;
  int consecutiveCount;
  int lastReading;
  unsigned long lastChangeTime;
};

PinFilter pin2Filter = {LOW, 0, LOW, 0};
PinFilter pin3Filter = {LOW, 0, LOW, 0};
PinFilter pin4Filter = {LOW, 0, LOW, 0};

// ======================
// ‚öôÔ∏è States
// ======================
int stablePin2 = LOW;
int stablePin3 = LOW;
int stablePin4 = LOW;

bool spindleRunning = false;
unsigned long spindleStart = 0;
unsigned long spindleOnTime = 0;

unsigned long lastUpdate = 0;
const unsigned long UPDATE_INTERVAL = 1000;

// ======================
// üîå Connect WiFi
// ======================
void connectWiFi() {
  Serial.print("Connecting to WiFi...");
  WiFi.config(localIP, gateway, subnet);
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("\n‚úÖ WiFi connected!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
}

// ======================
// üõ°Ô∏è ENHANCED Noise-Resistant Read
// ======================
int filteredRead(int pin, PinFilter &filter) {
  int reading = digitalRead(pin);
  unsigned long now = millis();
  
  // If reading matches the last reading
  if (reading == filter.lastReading) {
    filter.consecutiveCount++;
  } else {
    // Reading changed - reset counter
    filter.lastReading = reading;
    filter.consecutiveCount = 1;
    filter.lastChangeTime = now;
  }
  
  // Only accept new state if:
  // 1. We've seen it CONSECUTIVE_READS times
  // 2. Enough time has passed (DEBOUNCE_DELAY)
  if (filter.consecutiveCount >= CONSECUTIVE_READS && 
      (now - filter.lastChangeTime) >= DEBOUNCE_DELAY) {
    
    if (reading != filter.lastStableState) {
      // State change confirmed!
      Serial.print("üîÑ Pin ");
      Serial.print(pin);
      Serial.print(" confirmed change: ");
      Serial.print(filter.lastStableState);
      Serial.print(" ‚Üí ");
      Serial.println(reading);
      
      filter.lastStableState = reading;
      filter.consecutiveCount = 0; // Reset for next change
    }
  }
  
  return filter.lastStableState;
}

// ======================
// üì§ Send Update to Server
// ======================
bool sendUpdate(int p2, int p3, int p4, unsigned long onTime) {
  if (!client.connect(server, port)) {
    Serial.println("‚ùå Connection failed");
    return false;
  }

  String json = "{";
  json += "\"name\":\"" + String(deviceName) + "\",";
  json += "\"pin2\":" + String(p2) + ",";
  json += "\"pin3\":" + String(p3) + ",";
  json += "\"pin4\":" + String(p4) + ",";
  json += "\"onTime\":" + String(onTime);
  json += "}";

  client.print(
    String("POST /update HTTP/1.1\r\n") +
    "Host: " + server + "\r\n" +
    "Content-Type: application/json\r\n" +
    "Content-Length: " + json.length() + "\r\n" +
    "Connection: close\r\n\r\n" +
    json
  );

  unsigned long start = millis();
  while (millis() - start < 300 && client.available() == 0) { 
    delay(10); 
  }
  while (client.available()) {
    client.read();
  }
  client.stop();

  Serial.print("üì° Sent ‚Üí p2=");
  Serial.print(p2);
  Serial.print(" p3=");
  Serial.print(p3);
  Serial.print(" p4=");
  Serial.print(p4);
  Serial.print(" | onTime=");
  Serial.print(onTime / 1000);
  Serial.println("s");

  return true;
}

// ======================
// ‚öôÔ∏è Setup
// ======================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  // Configure pins with pull-down
  pinMode(pin2, INPUT_PULLDOWN);
  pinMode(pin3, INPUT_PULLDOWN);
  pinMode(pin4, INPUT_PULLDOWN);
  
  // Initialize filters with current state
  delay(100); // Let pins settle
  pin2Filter.lastStableState = digitalRead(pin2);
  pin3Filter.lastStableState = digitalRead(pin3);
  pin4Filter.lastStableState = digitalRead(pin4);
  
  pin2Filter.lastReading = pin2Filter.lastStableState;
  pin3Filter.lastReading = pin3Filter.lastStableState;
  pin4Filter.lastReading = pin4Filter.lastStableState;
  
  stablePin2 = pin2Filter.lastStableState;
  stablePin3 = pin3Filter.lastStableState;
  stablePin4 = pin4Filter.lastStableState;
  
  connectWiFi();
  
  Serial.println("üöÄ Spindle Monitor Ready!");
  Serial.println("üìå Enhanced Noise Filtering Active");
  Serial.println("   - Debounce: 250ms");
  Serial.println("   - Consecutive reads required: 5");
  Serial.println("Pin 2: Spindle ON/OFF");
  Serial.println("Pin 3: Process Start");
  Serial.println("Pin 4: Process End");
}

// ======================
// üîÅ Loop
// ======================
void loop() {
  // Reconnect WiFi if needed
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö†Ô∏è WiFi lost. Reconnecting...");
    connectWiFi();
    delay(1000);
    return;
  }

  // Read filtered pin states
  int p2 = filteredRead(pin2, pin2Filter);
  int p3 = filteredRead(pin3, pin3Filter);
  int p4 = filteredRead(pin4, pin4Filter);

  // Spindle ON logic
  if (p2 == HIGH && !spindleRunning) {
    spindleRunning = true;
    spindleStart = millis();
    Serial.println("üü¢ Spindle Started (Pin 2 = HIGH)");
  }

  // Spindle OFF logic
  if (p2 == LOW && spindleRunning) {
    spindleRunning = false;
    spindleOnTime += millis() - spindleStart;
    Serial.print("üî¥ Spindle Stopped (Pin 2 = LOW) | Total ON time: ");
    Serial.print(spindleOnTime / 1000);
    Serial.println(" sec");
  }

  // Calculate current ON time
  unsigned long currentOnTime = spindleOnTime;
  if (spindleRunning) {
    currentOnTime += (millis() - spindleStart);
  }

  // Detect state changes
  bool changed = (p2 != stablePin2) || (p3 != stablePin3) || (p4 != stablePin4);

  // Send updates
  if (changed || (spindleRunning && millis() - lastUpdate >= UPDATE_INTERVAL)) {
    sendUpdate(p2, p3, p4, currentOnTime);
    lastUpdate = millis();
  }

  // Save stable states
  stablePin2 = p2;
  stablePin3 = p3;
  stablePin4 = p4;

  delay(READ_INTERVAL); // 10ms delay for consistent reading
}