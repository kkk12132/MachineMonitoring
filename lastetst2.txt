#include <WiFiS3.h>
#include <Arduino.h>

// ======================
// WiFi Configuration
// ======================
const char* ssid = "JIO Office";
const char* password = "12345678@";

const char* server = "192.168.31.142";
const int port = 3000;
const char* deviceName = "arduino-1";

IPAddress localIP(192, 168, 31, 50);
IPAddress gateway(192, 168, 31, 1);
IPAddress subnet(255, 255, 255, 0);

WiFiClient client;

// ======================
// Pins
// ======================
const int PIN2 = 2;
const int PIN3 = 3;
const int PIN4 = 4;

// ======================
// Timing
// ======================
const unsigned long ON_CONFIRM_TIME = 250;
const unsigned long LOOP_DELAY = 5;

// ======================
// Debounce State
// ======================
struct DebouncedPin {
  int stableState;
  unsigned long highStart;
  int lastRaw;  // Track last raw reading
};

DebouncedPin p2 = {LOW, 0, LOW};
DebouncedPin p3 = {LOW, 0, LOW};
DebouncedPin p4 = {LOW, 0, LOW};

// ======================
// WiFi
// ======================
void connectWiFi() {
  WiFi.config(localIP, gateway, subnet);
  WiFi.begin(ssid, password);

  Serial.print("üîå Connecting WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\n‚úÖ WiFi connected");
  Serial.print("üì° Arduino IP: ");
  Serial.println(WiFi.localIP());
}

// ======================
// PLC-STYLE DEBOUNCE (FIXED)
// ======================
int readDebounced(int pin, DebouncedPin &dp) {
  int raw = digitalRead(pin);
  unsigned long now = millis();

  // If raw state changed, reset the timer (reject glitches)
  if (raw != dp.lastRaw) {
    dp.highStart = 0;
    dp.lastRaw = raw;
  }

  // If LOW, immediately set stable to LOW
  if (raw == LOW) {
    dp.stableState = LOW;
    dp.highStart = 0;
    return LOW;
  }

  // HIGH: start/continue timing
  if (dp.highStart == 0) {
    dp.highStart = now;
  }

  // Only confirm HIGH if it stayed HIGH continuously
  if (now - dp.highStart >= ON_CONFIRM_TIME) {
    dp.stableState = HIGH;
  }

  return dp.stableState;
}

// ======================
// Send Update
// ======================
void sendUpdate(int a, int b, int c) {
  if (!client.connect(server, port)) {
    Serial.println("‚ùå SERVER CONNECT FAILED");
    return;
  }

  Serial.println("‚úÖ SERVER CONNECTED");

  String json =
    "{"
    "\"name\":\"" + String(deviceName) + "\","
    "\"pin2\":" + String(a) + ","
    "\"pin3\":" + String(b) + ","
    "\"pin4\":" + String(c) +
    "}";

  client.print(
    "POST /update HTTP/1.1\r\n"
    "Host: " + String(server) + "\r\n"
    "Content-Type: application/json\r\n"
    "Connection: close\r\n"
    "Content-Length: " + String(json.length()) + "\r\n\r\n" +
    json
  );

  delay(5);
  client.stop();

  Serial.print("üì° Sent: ");
  Serial.print(a); Serial.print(" ");
  Serial.print(b); Serial.print(" ");
  Serial.println(c);
}

// ======================
// Setup
// ======================
void setup() {
  Serial.begin(115200);

  pinMode(PIN2, INPUT);
  pinMode(PIN3, INPUT);
  pinMode(PIN4, INPUT);

  connectWiFi();
  Serial.println("üöÄ Stable Monitor Ready");
}

// ======================
// Loop
// ======================
void loop() {
  static int last2 = LOW, last3 = LOW, last4 = LOW;

  int r2 = readDebounced(PIN2, p2);
  int r3 = readDebounced(PIN3, p3);
  int r4 = readDebounced(PIN4, p4);

  if (r2 != last2 || r3 != last3 || r4 != last4) {
    sendUpdate(r2, r3, r4);
  }

  last2 = r2;
  last3 = r3;
  last4 = r4;

  delay(LOOP_DELAY);
}